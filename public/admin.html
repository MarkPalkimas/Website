<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Dashboard - Mark Palkimas</title>
  <style>
    /* (same styles as before) */
  </style>
  <!-- RTDB client SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import {
      getDatabase,
      ref,
      get
    } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

    // 1) Init your Firebase client for RTDB
    const app = initializeApp({
      apiKey: "AIzaSyDds9UCMOcaoGT753uMNcT0y9847jN0oEI",
      authDomain: "mark-palkimas-visits.firebaseapp.com",
      databaseURL: "https://mark-palkimas-visits-default-rtdb.firebaseio.com"
    });
    const db = getDatabase(app);

    // 2) Fetch, group, and render
    async function loadLogs() {
      const snap = await get(ref(db, 'visitors'));
      const data = snap.val() || {};
      const grouped = {};
      Object.values(data).forEach(d => {
        const ip = d.ip || 'Unknown';
        const city = (d.location && (d.location.city || d.location.country_name)) || 'Unknown';
        const prov = (d.location && (d.location.org || d.location.isp)) || 'Unknown';
        const dev = d.deviceType || 'Unknown';
        const ts = d.timestamp || 0;

        if (!grouped[ip]) {
          grouped[ip] = { ip, count:0, latest: ts, city, prov, dev };
        }
        grouped[ip].count++;
        if (ts > grouped[ip].latest) grouped[ip].latest = ts;
      });

      const rows = Object.values(grouped)
        .sort((a,b)=> b.latest - a.latest);
      
      // render
      const tbody = document.querySelector('#visitor-logs tbody');
      tbody.innerHTML = '';
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#888;">No visits yet</td></tr>`;
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${new Date(r.latest).toLocaleString()}</td>
          <td>${r.ip}</td>
          <td>${r.city}</td>
          <td>${r.prov}</td>
          <td>${r.dev}</td>
          <td>${r.count}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadLogs();
      setInterval(loadLogs, 15000);
    });
  </script>
</head>
<body>
  <header>…</header>
  <div class="container">
    <div class="card">
      <h2>Visitor Logs</h2>
      <table id="visitor-logs">
        <thead>
          <tr>
            <th>Latest Visit</th>
            <th>IP Address</th>
            <th>Location</th>
            <th>Provider</th>
            <th>Device</th>
            <th>Visits</th>
          </tr>
        </thead>
        <tbody>
          <tr><td colspan="6" style="text-align:center;color:#888;">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</body>
</html>
